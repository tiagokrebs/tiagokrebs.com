<!DOCTYPE html>
<html lang="pt-br">

<head>
  <title>
  Clickhouse tutorial ¬∑ Tiago Krebs
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Tiago Krebs">
<meta name="description" content="Como o Clickhouse adiciona seu pr√≥prio flavor de processamento de dados a arquitetura dos DBMS colunares? Um breve tutorial sobre o tema, utilizando dataset contendo centenas de milhares de eventos, que apresenta a facilidade de uso da plataforma, seus conceitos b√°sicos al√©m de seu √≥timo desempenho no processamento de dados.">
<meta name="keywords" content="">

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Clickhouse tutorial"/>
<meta name="twitter:description" content="Como o Clickhouse adiciona seu pr√≥prio flavor de processamento de dados a arquitetura dos DBMS colunares? Um breve tutorial sobre o tema, utilizando dataset contendo centenas de milhares de eventos, que apresenta a facilidade de uso da plataforma, seus conceitos b√°sicos al√©m de seu √≥timo desempenho no processamento de dados."/>

<meta property="og:title" content="Clickhouse tutorial" />
<meta property="og:description" content="Como o Clickhouse adiciona seu pr√≥prio flavor de processamento de dados a arquitetura dos DBMS colunares? Um breve tutorial sobre o tema, utilizando dataset contendo centenas de milhares de eventos, que apresenta a facilidade de uso da plataforma, seus conceitos b√°sicos al√©m de seu √≥timo desempenho no processamento de dados." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tiagokrebs.com/pt-br/posts/clickhouse-tutorial/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-10T14:57:30-03:00" />
<meta property="article:modified_time" content="2021-10-10T14:57:30-03:00" />





<link rel="canonical" href="https://tiagokrebs.com/pt-br/posts/clickhouse-tutorial/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://tiagokrebs.com/pt-br/">
      Tiago Krebs
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/pt-br/posts/">Artigos</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/pt-br/about/">Sobre</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/">üá¨üáß</a>
              </li>
            
          
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://tiagokrebs.com/pt-br/posts/clickhouse-tutorial/">
              Clickhouse tutorial
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2021-10-10T14:57:30-03:00">
                outubro 10, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              12 minutos de leitura
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/pt-br/authors/tiago-krebs/">Tiago Krebs</a></div>

          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/pt-br/categories/tech/">Tech</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/pt-br/tags/clickhouse/">Clickhouse</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="/pt-br/tags/tutorial/">Tutorial</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="/pt-br/tags/data-engining/">Data Engining</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="/pt-br/tags/sql/">SQL</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>Clickhouse √© um banco de dados colunar criado por Alexey Milovidov na Yandex em 2009 com o objetivo de simplificar o processamento de dados interno da empresa. Em 2016 o projeto se tornou opensource e desde ent√£o vem ganhando cada vez mais notoriedade pela maturidade do c√≥digo, √≥timos resultados em benchmarks e vis√≠vel preocupa√ß√£o com cada nanossegundo de processamento.</p>
<p>Atualmente, apesar de contar com uma equipe relativamente pequena (15 desenvolvedores), j√° √© utilizado em grandes empresas de tecnologia como Uber, Tesla e eBay (<a href="https://clickhouse.com/docs/en/introduction/adopters/"  class="external-link" target="_blank" rel="noopener">veja a lista completa aqui</a>), al√©m de possuir in√∫meros cases de sucesso onde Petabytes de dados s√£o processados diariamente. Devido ao seu sucesso, recentemente o projeto recebeu aporte de $50M e est√° em fase de transi√ß√£o da Yandex para um bra√ßo da companhia dedicado √† plataforma, a Clickhouse Inc.</p>
<p>H√° alguns meses tive a oportunidade de liderar um projeto na Azion Technologies, onde substitu√≠mos diversas plataformas dos nossos pipelines de dados por Clickhouse. Hoje ele √© uma das principais ferramentas de consumo, processamento, transforma√ß√£o e storage de informa√ß√µes vindas de diferentes servi√ßos da empresa. Atrav√©s desse trabalho minha equipe entrega valor para outros squads e clientes na forma de eventos e m√©tricas, utilizados para medir desempenho dos nossos produtos, gera√ß√£o de insights, monitora√ß√£o e troubleshooting.
A simplicidade como a plataforma trata problemas complexos e a sua resili√™ncia me tornaram, al√©m de um s√≥lido Kafka fan boy, agora um Clickhouse fan boy tamb√©m.</p>
<p>Esse artigo traz uma breve descri√ß√£o sobre bancos de dados colunares e como o Clickhouse adicionou o seu pr√≥prio flavor a arquitetura. Al√©m disso, um tutorial breve, utilizando dataset contendo centenas de milhares de eventos, com a inten√ß√£o de mostrar a facilidade de uso da plataforma e seus conceitos b√°sicos.</p>
<h2 id="bancos-de-dados-colunares">
  Bancos de dados colunares
  <a class="heading-link" href="#bancos-de-dados-colunares">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Bancos de dados colunares s√£o conhecidos por implementar m√©todos mais precisos de busca e est√£o no mercado h√° muito tempo. Por defini√ß√£o, essa categoria de DBMS armazena os dados de tabelas em colunas no lugar de linhas. Considere que as tabelas de um banco de dados possuem duas dimens√µes, em um modelo de linhas podemos definir a seguinte tabela:</p>
<table>
<thead>
<tr>
<th>row</th>
<th>timestamp</th>
<th>id</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2021-09-30 18:36:01</td>
<td>1239</td>
<td>8374.9</td>
</tr>
<tr>
<td>2</td>
<td>2021-09-30 18:37:43</td>
<td>8571</td>
<td>2457.8</td>
</tr>
<tr>
<td>3</td>
<td>2021-09-30 18:40:17</td>
<td>1239</td>
<td>2734.3</td>
</tr>
<tr>
<td>2</td>
<td>2021-09-30 18:45:00</td>
<td>2323</td>
<td>5657.8</td>
</tr>
<tr>
<td>N</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>A mesma tabela em um banco de dados colunar pode ser representada da seguinte forma:</p>
<table>
<thead>
<tr>
<th>row</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>N</th>
</tr>
</thead>
<tbody>
<tr>
<td>timestamp</td>
<td>2021-09-30 18:36:01</td>
<td>2021-09-30 18:37:43</td>
<td>2021-09-30 18:40:17</td>
<td>2021-09-30 18:45:00</td>
<td>&hellip;</td>
</tr>
<tr>
<td>id</td>
<td>1239</td>
<td>8571</td>
<td>1239</td>
<td>2323</td>
<td>&hellip;</td>
</tr>
<tr>
<td>value</td>
<td>8374.9</td>
<td>2457.8</td>
<td>2734.3</td>
<td>5657.8</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>√â comum olharmos para a estrutura acima e inferirmos que apenas a forma como os valores s√£o organizados difere, por√©m, existe uma mudan√ßa sutil no mapeamento dos dados que altera a indexa√ß√£o completamente: em sistemas orientados a colunas as chaves prim√°rias s√£o os dados. Na minha melhor tentativa de explicar essa afirma√ß√£o, considere o index abaixo em um sistema de linhas.</p>
<table>
<thead>
<tr>
<th>row</th>
<th>id</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1239</td>
</tr>
<tr>
<td>2</td>
<td>8571</td>
</tr>
<tr>
<td>3</td>
<td>1239</td>
</tr>
<tr>
<td>2</td>
<td>2323</td>
</tr>
<tr>
<td>N</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>Nesse caso o storage do index faz o mapeamento para cada linha da tabela original. A chave prim√°ria √© <code>row</code> que est√° mapeada pelo dado indexado. Agora compare com o index abaixo, em um sistema colunar.</p>
<table>
<thead>
<tr>
<th>row</th>
<th>1,3</th>
<th>2</th>
<th>4</th>
<th>N</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>1239</td>
<td>8571</td>
<td>2323</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>A chave prim√°ria √© o dado, que est√° mapeado por <code>row</code>. Nesse sistema al√©m dos valores serem armazenados em colunas, quando iguais tamb√©m s√£o compactados juntos. Note o index para o <code>id</code> <code>1239</code> do nosso exemplo, o mesmo valor √© referenciado por apenas uma √∫nica coluna: <code>row</code> <code>1,3</code>. Uma das principais possibilidades que essa forma de mapeamento abre √© a otimiza√ß√£o de storage atrav√©s de algoritmos modernos de compacta√ß√£o.</p>
<p>Devido as suas caracter√≠sticas, bancos de dados colunares s√£o mais adequados para arquitetura OLAP com grande quantidade de consultas complexas e opera√ß√µes esparsas, ou seja, que n√£o utilizam todos os campos das tabelas. Quando consideramos que, os casos onde todas as colunas de uma tabela precisam ser recuperados s√£o raros, podemos dizer que esse √© um trade-off aceit√°vel. Ao mesmo tempo, em um modelo colunar inser√ß√µes exigem transa√ß√£o e compacta√ß√£o por coluna. Essa necessidade pode trazer desempenho inferior que a arquitetura OLTP, quando todos os campos s√£o informados. Entretanto, essa categoria de opera√ß√£o n√£o afeta a ingest√£o de dados no Clickhouse, visto que n√£o h√° controle de transa√ß√£o.</p>
<p>Em resumo, apesar de n√£o ser totalmente verdadeiro, podemos dizer que, na pr√°tica, bancos de dados colunares s√£o mais adequados para trabalho com OLAP enquanto bancos de dados orientados a linhas tem melhor afinidade com opera√ß√µes OLTP. Quanto ao Clickhouse tamb√©m podemos concluir que o sistema faz uso total das vantagens de uma arquitetura OLAP, enquanto resolve algumas limita√ß√µes do modelo.</p>
<p>Esses s√£o alguns exemplos de DBMS colunares (de verdade) dispon√≠veis hoje no mercado: AWS Redshift, Vertica, InfiniDB, SAP HANA, Google BigQuery e Druid.</p>
<h2 id="clickhouse-twist">
  Clickhouse twist
  <a class="heading-link" href="#clickhouse-twist">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<blockquote>
<p>Minha equipe e eu enfrentamos v√°rios desafios de processamento de dados que frequentemente exigiam estruturas de dados personalizadas e algoritmos sofisticados, solu√ß√µes criativas e trade-offs, profundo conhecimento da √°rea de dom√≠nio, hardware e matem√°tica. Eu adoro dados e processamento em restri√ß√µes extremas, onde voc√™ tem que pensar em bytes e nanossegundos para economizar petabytes e segundos.
A equipe do ClickHouse compartilha essa paix√£o, na minha opini√£o, esta √© a principal raz√£o do sucesso do ClickHouse. - Alexey Milovidov, l√≠der t√©cnico do projeto.</p>
</blockquote>
<p>Al√©m de herdar a gen√©tica dos DBMS colunares o Clickhouse possui engines dedicadas a facilitar o processamento de dados de forma distribu√≠da, ao mesmo tempo que prov√™ alta disponibilidade. Tamb√©m h√° integra√ß√£o de origens externas com diversas ferramentas de mercado atrav√©s de foreign tables e processamento orientado a table functions. Essas caracter√≠sticas adicionam uma camada de abstra√ß√£o e facilidade ao dia a dia do engenheiro de dados, que pode reunir, combinar e processar informa√ß√µes de diversos sources sem precisar se preocupar com um grande conjunto de ferramentas e processos.</p>
<p>As features mais importantes do Clickhouse est√£o vinculadas a fam√≠lia Merge Tree, engine que define a inser√ß√£o e storage, e portanto, respons√°vel direta pelo desempenho de escrita, transforma√ß√£o e leitura dos dados. Em resumo, a Merge Tree foi criada para suportar uma grande quantidade de inser√ß√µes nas tabelas. Os dados s√£o escritos em <em>parts</em>, ap√≥s regras s√£o aplicadas para realizar o <em>merge</em> das <em>parts</em> em background. O m√©todo √© muito mais eficiente do que a escrita constante do dado no storage durante o insert. Essa opera√ß√£o abre possibilidade para as principais features da engine.</p>
<ul>
<li><strong>Storage ordenado por chave prim√°ria</strong>: permite a cria√ß√£o de √≠ndices esparsos para melhorar o desempenho das queries.</li>
<li><strong>Chave de particionamento</strong>: opera√ß√µes diretamente com o particionamento s√£o mais eficientes que opera√ß√µes comuns, a <em>partition key</em> √© utilizada como ponto de corte das queries, promovendo mais desempenho.</li>
<li><strong>Replica√ß√£o</strong>: habilita replica√ß√£o de tabelas entre nodos do mesmo cluster ou at√© mesmo localmente entre diferentes discos.</li>
<li><strong>Sampling</strong>: se necess√°rio √© poss√≠vel definir o m√©todo de sampling para as queries na tabela.</li>
<li><strong>Agrega√ß√£o</strong>: √© facilitada com base em regras na tabela, permitindo que sejam aplicadas diretamente pela engine ap√≥s a opera√ß√£o de insert.</li>
<li><strong>Tempo de vida</strong>: √© poss√≠vel definir o TTL para tabelas e/ou colunas, as a√ß√µes de dele√ß√£o ou movimenta√ß√£o dos dados s√£o feitas pela engine com base nas regras.</li>
<li><strong>Storage em m√∫ltiplos dispositivos</strong>: atrav√©s de pol√≠ticas de storage √© poss√≠vel criar regras para utiliza√ß√£o de discos e volumes espec√≠ficos conforme a tabela (arquitetura hot/warm/cold). Al√©m disso, Block Storages externos s√£o extendidos como discos pelas policies, abrindo a possibilidade de integra√ß√£o transparente com S3 e HDFS.</li>
</ul>
<p>Essas caracter√≠sticas est√£o dispon√≠veis atrav√©s de diferentes engines que comp√µem a fam√≠lia Merge Tree e podem ser combinadas entre si. Alguns exemplos s√£o: <code>MergeTree</code>, <code>SummingMergeTree</code>, <code>ReplacingMergeTree</code>, <code>AggregatingMergeTree</code>, <code>CollapsingMergeTree</code>, <code>VersionedCollapsingMergeTree</code> e<code>GraphiteMergeTree</code>. Para cada uma dessas engines ainda √© poss√≠vel adicionar a caracter√≠stica de replica√ß√£o concatenando <code>Replicated*</code> ao nome, como <code>ReplicatedAggregatingMergeTree</code>.</p>
<h2 id="tutorial">
  Tutorial
  <a class="heading-link" href="#tutorial">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Neste tutorial vamos criar um nodo Clickhouse Standalone. Ap√≥s, utizamos o dataset <a href="https://www.kaggle.com/stackoverflow/stacksample"  class="external-link" target="_blank" rel="noopener">StackSample: 10% of Stack Overflow Q&amp;A</a> a fim de demonstrar algumas das funcionalidades do banco de dados.</p>
<h3 id="install-clickhouse">
  Install Clickhouse
  <a class="heading-link" href="#install-clickhouse">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h3>
<p>Os pacotes de instala√ß√£o do Clickhouse est√£o dispon√≠veis para os principais gerenciadores e distribui√ß√µes, tr√™s s√£o necess√°rios: <code>clickhouse-common</code>, <code>clickhouse-server</code> e <code>clickhouse-client</code>. Escolha o seu favorito, instale utilizando yum, dnf, apt, atrav√©s de scripts disponibilizados pela comunidade ou compile a aplica√ß√£o voc√™ mesmo. Para mais detalhes sobre o processo de instala√ß√£o veja <a href="https://clickhouse.com/docs/en/getting-started/install/"  class="external-link" target="_blank" rel="noopener">a documenta√ß√£o oficial</a>.</p>
<p>Aqui vamos utilizar Docker Compose. Edite o arquivo <code>docker-compose.yaml</code> conforme abaixo.</p>
<pre tabindex="0"><code>version: &#34;3&#34;
services:

  clickhouse-client:
    container_name: &#34;clickhouse-client&#34;
    image: yandex/clickhouse-client
    command: [&#39;--host&#39;, &#39;clickhouse-standalone&#39;]

  clickhouse-standalone:
    container_name: &#34;clickhouse-standalone&#34;
    image: yandex/clickhouse-server
    ports:
      - 8123:8123
      - 9000:9000
    volumes:
      - &#34;./data/:/data&#34;
    hostname: &#34;clickhouse-standalone&#34;
</code></pre><p>Inicie o ambiente.</p>
<pre tabindex="0"><code>$ docker-compose up -d
</code></pre><p>Apenas o container <code>clickhouse-standalone</code> deve estar Up. N√£o se preocupe com o <code>clickhouse-client</code> por enquanto.</p>
<h3 id="dataset">
  Dataset
  <a class="heading-link" href="#dataset">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h3>
<p>Vamos utilizar o dataset <a href="https://www.kaggle.com/stackoverflow/stacksample"  class="external-link" target="_blank" rel="noopener">StackSample: 10% of Stack Overflow Q&amp;A</a> disponibilizado no Kaggle. O conjunto de dados possui uma amostra de perguntas e respostas do site entre 2008 e 2016. Se voc√™ quiser conhecer mais sobre os data dumps disponibilizados pela Stack Exchange v√° at√© <a href="https://data.stackexchange.com/"  class="external-link" target="_blank" rel="noopener">data.stackexchange.com</a> e <a href="https://archive.org/details/stackexchange"  class="external-link" target="_blank" rel="noopener">archive.org/details/stackexchange</a>.</p>
<p>Fa√ßa o download do dataset e descompacte na pasta <code>data</code> do seu local.</p>
<pre tabindex="0"><code>$ mkdir data
$ mv ~/Downloads/archive.zip data/
$ unzip data/archive.zip -d data/
</code></pre><h3 id="tabelas">
  Tabelas
  <a class="heading-link" href="#tabelas">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h3>
<p>Para criar as tabelas, abra o CLI do Clickhouse.</p>
<pre tabindex="0"><code>$ docker exec -it clickhouse-standalone clickhouse-client --host clickhouse-standalone --multiquery

ClickHouse client version 21.9.3.30 (official build).
Connecting to clickhouse-standalone:9000 as user default.
Connected to ClickHouse server version 21.9.3 revision 54449.

clickhouse-standalone :)
</code></pre><p>A engine SQL da plataforma contempla todas as principais caracter√≠sticas esperadas como operadores, fun√ß√µes, dicion√°rios, types, views, objetos materializados e compatibilidade com ANSI SQL. A documenta√ß√£o oficial sobre o dialeto SQL do Clickhouse pode ser encontrada <a href="https://clickhouse.com/docs/en/sql-reference/syntax/"  class="external-link" target="_blank" rel="noopener">aqui</a>.</p>
<p>Inicie criando a database para o tutorial.</p>
<pre tabindex="0"><code>CREATE DATABASE IF NOT EXISTS tutorial;
</code></pre><p>Ent√£o crie as tabelas que receber√£o os dados do dataset.</p>
<pre tabindex="0"><code>CREATE TABLE tutorial.tags
(
    Id UInt32,
    Tag String
)
ENGINE = MergeTree()
ORDER BY (Id, Tag);

CREATE TABLE tutorial.answers
(
    Id UInt32,
    OwnerUserId String,
    CreationDate DateTime,
    ParentId String,
    Score Int32,
    Body String
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(CreationDate)
ORDER BY (ParentId, CreationDate);

CREATE TABLE tutorial.questions
(
    Id UInt32,
    OwnerUserId String,
    CreationDate DateTime,
    ClosedDate Nullable(DateTime),
    Score Int32,
    Title String,
    Body String
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(CreationDate)
ORDER BY (OwnerUserId, CreationDate);
</code></pre><p>Experimente utilizar a instru√ß√£o <a href="https://clickhouse.com/docs/en/sql-reference/statements/grant/#grant-show"  class="external-link" target="_blank" rel="noopener">SHOW</a> para visualiar o objetos que acabamos de criar.</p>
<h3 id="importa√ß√£o-dos-dados">
  Importa√ß√£o dos dados
  <a class="heading-link" href="#importa%c3%a7%c3%a3o-dos-dados">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h3>
<p>A interface de entrada e sa√≠da do Clickhouse √© bastante completa e possui integra√ß√£o com diversos formatos de dados. Atrav√©s da engine SQL √© poss√≠vel definir o formato para <code>INPUT</code> e <code>OUTPUT</code> al√©m da origem e/ou destino das informa√ß√µes. Com isso, importar, exportar ou at√© mesmo converter datasets em formatos como TSV, CSV, XML, JSON, TSKV, etc s√£o opera√ß√µes que podem ser abstra√≠das facilmente pela plataforma. Veja mais em <a href="https://clickhouse.com/docs/en/interfaces/formats/"  class="external-link" target="_blank" rel="noopener">Formats for Input and Output Data</a>.</p>
<p>O dataset do tutorial √© composto por tr√™s arquivos CSV, para import√°-los utilize as instru√ß√µes abaixo.</p>
<p>Abra uma sess√£o bash com o Clickhouse Standalone.</p>
<pre tabindex="0"><code>$ docker exec -it clickhouse-standalone bash
</code></pre><p>Importe <code>Tag.csv</code>.</p>
<pre tabindex="0"><code>$ cat /data/Tags.csv \
    | /usr/bin/clickhouse --client \
    --query=&#34;INSERT INTO tutorial.tags FORMAT CSVWithNames&#34;
</code></pre><p>Importe <code>Answers.csv</code>. Note que, diferente do exemplo acima, nessa etapa estamos selecionando colunas espec√≠ficas do CSV e ajustando o formado esperado para o campo <code>CreationDate</code> atrav√©s da fun√ß√£o <code>parseDateTimeBestEffort</code>.</p>
<pre tabindex="0"><code>$ cat /data/Answers.csv \
    | /usr/bin/clickhouse --client \
    --query=&#34;INSERT INTO tutorial.answers SELECT Id UInt32, OwnerUserId, toDateTime(parseDateTimeBestEffort(CreationDate)) AS CreationDate, ParentId, Score, Body FROM input(&#39;Id UInt32, OwnerUserId String, CreationDate String, ParentId String, Score Int32, Body String&#39;) FORMAT CSVWithNames&#34;
</code></pre><p>Importe <code>Questions.csv</code>. Para essa tabela, al√©m do ajuste de valor para algumas colunas, utilizamos a op√ß√£o <code>input_format_allow_errors_ratio</code> a fim de configurar um percentual de erros aceit√°vel no procedimento de importa√ß√£o (linhas mal formadas s√£o descartadas).</p>
<pre tabindex="0"><code>$ cat /data/Questions.csv \
    sed &#34;s/&#39;/ /g&#34; | /usr/bin/clickhouse \
    --client --query=&#34;INSERT INTO tutorial.questions SELECT Id UInt32, OwnerUserId, toDateTime(parseDateTimeBestEffort(CreationDate)) AS CreationDate, toDateTime(parseDateTimeBestEffort(replaceOne(ClosedDate, &#39;NA&#39;, null))) AS ClosedDate, Score, Title, Body FROM input(&#39;Id UInt32, OwnerUserId String, CreationDate String, ClosedDate String, Score Int32, Title String, Body String&#39;) FORMAT CSVWithNames&#34; \
    --input_format_allow_errors_ratio=0.5
</code></pre><p>Encerre a sess√£o bash com <code>clickhosue-standalone</code>.</p>
<h3 id="queries">
  Queries
  <a class="heading-link" href="#queries">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h3>
<p>Como vimos anteriormente, tabelas da fam√≠lia MergeTree fazem <em>merge</em> das <em>parts</em> quando necess√°rio. N√≥s podemos for√ßar essa opera√ß√£o realizando o <code>OPTIMIZE</code> das tabelas agora, no lugar de esperar a engine decidir o melhor momento.</p>
<p>Abra o CLI do Clickhouse Standalone novamente e execute as queries abaixo.</p>
<pre tabindex="0"><code>OPTIMIZE TABLE tutorial.tags FINAL;
OPTIMIZE TABLE tutorial.answers FINAL;
OPTIMIZE TABLE tutorial.questions FINAL;
</code></pre><p>Selecione alguns registros das Tags.</p>
<pre tabindex="0"><code>clickhouse-standalone :) SELECT * FROM tutorial.tags LIMIT 5;

SELECT *
FROM tutorial.tags
LIMIT 5

Query id: 90752735-6cce-4220-92ce-ff61d6d4eb6c

‚îå‚îÄId‚îÄ‚î¨‚îÄTag‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 80 ‚îÇ actionscript-3        ‚îÇ
‚îÇ 80 ‚îÇ air                   ‚îÇ
‚îÇ 80 ‚îÇ flex                  ‚îÇ
‚îÇ 90 ‚îÇ branch                ‚îÇ
‚îÇ 90 ‚îÇ branching-and-merging ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

5 rows in set. Elapsed: 0.004 sec. 
</code></pre><p>Obtenha o menor e maior score das respostas de todo o per√≠odo.</p>
<pre tabindex="0"><code>clickhouse-standalone :) SELECT min(Score) AS min, max(Score) AS max FROM answers;

SELECT
    min(Score) AS min,
    max(Score) AS max
FROM answers

Query id: 7c8f3422-8ed9-4090-ac18-9085f8cbc7b1

‚îå‚îÄmin‚îÄ‚î¨‚îÄ‚îÄmax‚îÄ‚îê
‚îÇ -42 ‚îÇ 5718 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 rows in set. Elapsed: 0.010 sec. Processed 2.01 million rows, 8.06 MB (192.16 million rows/s., 768.64 MB/s.)
</code></pre><p>Obtenha quantas perguntas cont√©m a string <code>pyhton</code> em cada ano.</p>
<pre tabindex="0"><code>clickhouse-standalone :) SELECT toYear(CreationDate) AS year, count() FROM questions WHERE Body ilike(&#39;%python%&#39;) GROUP BY year ORDER BY year;

SELECT
    toYear(CreationDate) AS year,
    count()
FROM questions
WHERE Body ILIKE &#39;%python%&#39;
GROUP BY year
ORDER BY year ASC

Query id: 3aa8083a-cd49-40ae-8149-1d8ec42bccfb

‚îå‚îÄyear‚îÄ‚î¨‚îÄcount()‚îÄ‚îê
‚îÇ 2008 ‚îÇ     388 ‚îÇ
‚îÇ 2009 ‚îÇ    2180 ‚îÇ
‚îÇ 2010 ‚îÇ    4036 ‚îÇ
‚îÇ 2011 ‚îÇ    6284 ‚îÇ
‚îÇ 2012 ‚îÇ    9158 ‚îÇ
‚îÇ 2013 ‚îÇ   12914 ‚îÇ
‚îÇ 2014 ‚îÇ   14666 ‚îÇ
‚îÇ 2015 ‚îÇ   17538 ‚îÇ
‚îÇ 2016 ‚îÇ    9058 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

9 rows in set. Elapsed: 0.868 sec. Processed 2.31 million rows, 3.25 GB (2.67 million rows/s., 3.75 GB/s.)
</code></pre><p>That&rsquo;s it. Esse tutorial e outros exemplos podem ser encontrados em <a href="https://github.com/tiagokrebs/clickhouse-lab"  class="external-link" target="_blank" rel="noopener">github.com/tiagokrebs/clickhouse-lab</a>.</p>
<h2 id="cases-de-sucesso">
  Cases de sucesso
  <a class="heading-link" href="#cases-de-sucesso">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<ul>
<li>Cloudflare, <a href="https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse/"  class="external-link" target="_blank" rel="noopener">HTTP Analytics for 6M requests per second using ClickHouse</a></li>
<li>Uber, <a href="https://presentations.clickhouse.com/meetup40/uber.pdf"  class="external-link" target="_blank" rel="noopener">Fast, Scalable and Reliable Logging at Uber with Clickhouse</a></li>
<li>eBay, <a href="https://tech.ebayinc.com/engineering/ou-online-analytical-processing/"  class="external-link" target="_blank" rel="noopener">Our Online Analytical Processing Journey with ClickHouse on Kubernetes</a></li>
<li>Spotify, <a href="https://www.slideshare.net/glebus/using-clickhouse-for-experimentation-104247173"  class="external-link" target="_blank" rel="noopener">Using ClickHouse for Experimentation</a></li>
</ul>
<h2 id="refer√™ncias">
  Refer√™ncias
  <a class="heading-link" href="#refer%c3%aancias">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p><a href="https://clickhouse.com/blog/en/2021/clickhouse-inc/"  class="external-link" target="_blank" rel="noopener">Introducing ClickHouse, Inc.</a><br>
<a href="https://www.businesswire.com/news/home/20210920005219/en/ClickHouse-Inc.-Announces-Incorporation-Along-With-50M-In-Series-A-Funding"  class="external-link" target="_blank" rel="noopener">ClickHouse, Inc. Announces Incorporation, Along With $50M In Series A Funding</a><br>
<a href="https://yandex.com/company/press_center/press_releases/2021/2021-09-20"  class="external-link" target="_blank" rel="noopener">Yandex Spins Off ClickHouse into Standalone Company</a><br>
<a href="https://ghe.clickhouse.tech/#let-s-play-with-the-data"  class="external-link" target="_blank" rel="noopener">Everything You Always Wanted To Know
About GitHub</a><br>
<a href="https://clickhouse.com/docs/en/"  class="external-link" target="_blank" rel="noopener">Clickhouse Documentation</a><br>
<a href="https://data.stackexchange.com/"  class="external-link" target="_blank" rel="noopener">Stack Exchange Data Explorer</a><br>
<a href="https://archive.org/details/stackexchange"  class="external-link" target="_blank" rel="noopener">Stack Exchange Data Dump</a></p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "tiagokrebs-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    
    
    2024
     Tiago Krebs 
    ¬∑
    
    Promovido por <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://azion.com" target="_blank" rel="noopener">Azion</a>
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2WDTGVBCNQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2WDTGVBCNQ');
</script>


  

  

  

  

  

  

  
</body>

</html>
